# ABBA_Coregistration_Analysis_Tools
NOTE: IF YOU ARE HAVING ISSUES WITH THE OVERLAY DISPLAY ON SINGLE CHANNEL COREGISTERED EXPORTS, PLEASE READ THE UPDATE AT THE BOTTOM OF THIS FILE -

Scripts to aid data pre- and post-processing when coregistering 3D mouse brains with Nicolas Chiaruttini's ABBA tool
Please reference this protocol for more information: https://www.protocols.io/view/a-free-analysis-pipeline-to-coregister-3d-lightshe-dcgz2tx6
The general order and use of the scripts downloadable at this github address are as follows:
1. The reslice.py script allows reslicing of an image in Z by a customizable factor. Use this to reduce the number of sections being imported into ABBA, if necessary.
2. The channel_macro (s) convert an image series where the channels have been split into an image series where each slice contains all channels. Please use this macro if importing multiple channels into ABBA. There are multiple versions of this macro that correspond to the number of channels being imported into ABBA. For example, channel_macro_2 is for two channels, channel_macro_3 is for three channels, etc.
3. After coregistration and segmentation, the cells macro will analyze all coregisetered, segmented slices in a folder and save the results in a series of .csv files.
4. The excel_crunch.py script combines the .csv files generated by the above macro into a single file, aggregating all data into one row per region and one column per statistic.
5. The excel_merge.py script combines multiple .csv outputs of excel_crunch.py into a single .csv file. Importantly, excel_merge is designed to handle excel_crunch outputs whose brain regions exist in differing orders, or otherwise missing regions, which may occur due to differing coregistrations changing which regions the cells_macro encounters first, or certain regions being discluded when exporting the coregistered brain (which is a factor that prevents simple copy+pasting between excel files). Please note that excel_merge.py is deprecated and may not run beyond pandas 2.2.0. If this occurs, please revert pandas to version 2.2.0.
6. The stat_test.py and stat_test_clusters.py are designed to establish significant differences between regions. These tests should be run on two excel files containing the data from two cohorts, in the order that they are generated by excel_merge.py. 


PROTOCOL UPDATE/ADDRESSING A BUG - PLEASE READ: A user has reported to me that ImageJ/ABBA has an issue displaying the coregistered overlay when exporting single channel images. You may see the overlay for all slices on every single slice, negatively affecting visibility. This is not an issue when exporting for multiple channels, so I did not encounter myself, having only utilized multiple channels. I do not believe this bug affects actual data analysis, but I am not 100% sure, so you may want to fix it using the following steps. If you are working with a single channel, this visual bug can easily be fixed with the following quick steps:
  1. The visual bug seems directly related to how the overlay interacts with single channel images, so we will temporarily save it as a two channel image before converting it back to one channel.
  2. First, open the 1-channel ABBA coregistered export image with overlay in FIJI/ImageJ. Use Image -> Overlay -> To ROI Manager to copy the overlay into the ROI Manager.
  3. Select your 1-channel coregistered image again and select Image -> Overlay -> Remove Overlay. This will remove the incorrect-appearing overlay, while the overlay data itself is stored in the ROI manager.
  4. Right Click the Image (with overlay now removed) and select Duplicate (or use image -> Duplicate). Duplicate the entire image with all Z slices.
  5. Now, use Image -> Color -> Merge Channels to create a temporary, two channel copy of your coregistered Image.
  6. Use Image -> Overlay -> From ROI Manager to move the overlay data into the ROI manager onto your two channel coregistered image. The overlay will now appear as intended.
  7. Save the resulting two channel image.
  8. Next, use Image -> Color -> Split channels to return both to one-channel images. These one-channel images will have the proper Overlay and can be safely saved and used for any analysis.
